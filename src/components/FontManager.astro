--- 
import { siteConfig } from "../config";

const { font: fontConfig } = siteConfig;

// Dapatkan font yang dipilih
const getSelectedFonts = () => {
  if (!fontConfig.enable || !fontConfig.selected) return [];

  const selectedIds = Array.isArray(fontConfig.selected)
    ? fontConfig.selected
    : [fontConfig.selected];

  return selectedIds
    .map((id) => fontConfig.fonts[id])
    .filter((font) => font && font.src); // Saring font sistem dan font yang tidak ada
};

const selectedFonts = getSelectedFonts();

// Hasilkan nama kelas CSS font
const generateFontClasses = () => {
  if (!fontConfig.enable) return [];

  const selectedIds = Array.isArray(fontConfig.selected)
    ? fontConfig.selected
    : [fontConfig.selected];

  return selectedIds.map((id) => `font-${id}-enabled`);
};

const fontClasses = generateFontClasses();

// Hasilkan gaya cadangan font-family
const generateFontFamilyStyle = () => {
  if (!fontConfig.enable || !fontConfig.selected) return "";

  const selectedIds = Array.isArray(fontConfig.selected)
    ? fontConfig.selected
    : [fontConfig.selected];

  const selectedFontFamilies = selectedIds
    .map((id) => fontConfig.fonts[id])
    .filter((font) => font)
    .map((font) => `"${font.family}"`);

  if (selectedFontFamilies.length === 0) return "";

  const fallbacks = fontConfig.fallback || [];
  const allFonts = [...selectedFontFamilies, ...fallbacks];

  return `font-family: ${allFonts.join(", ")};`;
};

const fontFamilyStyle = generateFontFamilyStyle();
---

<!-- Tautan stylesheet font -->{ 
  selectedFonts.map((font) => {
    // Tentukan apakah itu tautan eksternal
    const isExternalUrl =
      font.src.startsWith("http://") ||
      font.src.startsWith("https://") ||
      font.src.startsWith("//");

    if (isExternalUrl) {
      // Tautan font eksternal (mis. Google Fonts, CDN, dll.)
      return <link rel="stylesheet" href={font.src} />;
    } else {
      // File font lokal
      return (
        <style
          set:html={`
        @font-face {
          font-family: "${font.family}";
          src: url("${font.src}") ${font.format ? `format("${font.format}")` : ""};
          ${font.weight ? `font-weight: ${font.weight};` : ""}
          ${font.style ? `font-style: ${font.style};` : ""}
          ${font.display ? `font-display: ${font.display};` : ""}
          ${font.unicodeRange ? `unicode-range: ${font.unicodeRange};` : ""}
        }
      `}
        />
      );
    }
  })
}

<!-- Tautan pramuat font -->
{
  fontConfig.enable &&
    fontConfig.preload &&
    selectedFonts
      .filter((font) => !font.src.startsWith("http"))
      .map((font) => (
        <link
          rel="preload"
          href={font.src}
          as="font"
          type={`font/${font.format || "woff2"}`}
          crossorigin
        />
      ))
}

<!-- Gaya font global -->
{
  fontConfig.enable && fontFamilyStyle && (
    <style
      set:html={`
    :root {
      --font-family-custom: ${selectedFonts.map((font) => `"${font.family}"`).join(", ")};
      --font-family-fallback: ${(fontConfig.fallback || []).join(", ")};
    }
    
    /* Terapkan font kustom ke body */
    body {
      ${fontFamilyStyle}
    }
    
    /* Hasilkan kelas CSS yang sesuai untuk setiap font yang dipilih */
    ${selectedFonts
      .map((font) => {
        return `
        .font-${font.id},
        .font-${font.id} * {
          font-family: "${font.family}", var(--font-family-fallback) !important;
        }
      `;
      })
      .join("\n")}
    
    /* Tambahkan nama kelas untuk body dengan font yang diaktifkan secara keseluruhan */
    ${fontClasses.map((className) => `.${className}`).join(",\n")} {
      /* Gaya global terkait font dapat ditambahkan di sini */
    }
  `}
    />
  )
}

<script>
  // Optimisasi pemuatan font dan penanganan kesalahan
  if (document.fonts && typeof document.fonts.ready !== "undefined") {
    document.fonts.ready
      .then(() => {
        console.log("Semua font telah dimuat");

        // Picu event kustom untuk memberi tahu bahwa font telah dimuat
        document.dispatchEvent(new CustomEvent("fontsLoaded"));
      })
      .catch((error: Error) => {
        console.warn("Pemuatan font gagal:", error);
      });
  }

  // Pemantauan kinerja pemuatan font
  if (typeof PerformanceObserver !== "undefined") {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === "resource") {
          // console.log(`Sumber daya font dimuat: ${entry.name} (${entry.duration.toFixed(2)}ms)`);
        }
      });
    });

    try {
      observer.observe({ entryTypes: ["resource"] });
    } catch (e) {
      // Gagal secara diam-diam jika browser tidak mendukung
    }
  }
</script>