---
import { commentConfig } from "../../config/commentConfig";

interface Props {
  path: string;
}

const config = {
  ...commentConfig.twikoo,
  el: "#tcomment",
  path: Astro.props.path,
};
---

<div id="tcomment"></div>
<!-- Gunakan file Twikoo yang dikompilasi sendiri untuk menghindari tombol suka, dll., yang menyebabkan halaman bergulir ke atas https://github.com/twikoojs/twikoo/issues/721 -->
<script is:inline src="/assets/js/firefly-twikoo-1.6.44.all.min.js"></script>
<script is:inline define:vars={{ config }}>
  // Dapatkan path halaman saat ini
  function getCurrentPath() {
    const pathname = window.location.pathname;
    return pathname.endsWith("/") && pathname.length > 1
      ? pathname.slice(0, -1)
      : pathname;
  }

  // Buat objek konfigurasi secara dinamis
  function createTwikooConfig() {
    return {
      ...config,
      path: getCurrentPath(),
      el: "#tcomment",
    };
  }

  // Inisialisasi Twikoo
  function initTwikoo() {
    if (typeof twikoo !== "undefined") {
      const commentEl = document.getElementById("tcomment");
      if (commentEl) {
        commentEl.innerHTML = "";

        const dynamicConfig = createTwikooConfig();
        console.log("[Twikoo] Inisialisasi konfigurasi:", dynamicConfig);

        twikoo
          .init(dynamicConfig)
          .then(() => {
            console.log("[Twikoo] Inisialisasi selesai");
          })
          .catch((error) => {
            console.error("[Twikoo] Inisialisasi gagal:", error);
          });
      }
    } else {
      // Jika Twikoo belum dimuat, coba lagi nanti
      setTimeout(initTwikoo, 500);
    }
  }

  // Inisialisasi saat halaman dimuat
  document.addEventListener("DOMContentLoaded", initTwikoo);

  // Inisialisasi ulang setelah pergantian halaman Swup
  if (window.swup && window.swup.hooks) {
    window.swup.hooks.on("content:replace", function () {
      setTimeout(initTwikoo, 200);
    });
  } else {
    document.addEventListener("swup:enable", function () {
      if (window.swup && window.swup.hooks) {
        window.swup.hooks.on("content:replace", function () {
          setTimeout(initTwikoo, 200);
        });
      }
    });
  }

  // Listener event kustom
  document.addEventListener("firefly:page:loaded", function () {
    const commentEl = document.getElementById("tcomment");
    if (commentEl) {
      console.log("[Twikoo] Inisialisasi ulang melalui event kustom");
      initTwikoo();
    }
  });
</script>