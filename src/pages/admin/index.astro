---
const configPath = "/admin/config.yml";
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Content Manager</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
  </head>
  <body>
    <!-- Include the script that builds the page and powers Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
      window.addEventListener("load", () => {
        if (window.CMS) {
          window.CMS.init({ configPath: "/admin/config.yml" });
        }
      });
    </script>
    <script is:inline>
      document.addEventListener("DOMContentLoaded", () => {
        const identity = window.netlifyIdentity;
        if (!identity) return;

        const openIfNeeded = () => {
          const hash = window.location.hash || "";
          if (
            hash.includes("invite_token") ||
            hash.includes("confirmation_token") ||
            hash.includes("recovery_token")
          ) {
            if (hash.includes("recovery_token")) {
              identity.open("recovery");
            } else {
              identity.open();
            }
          }
        };

        identity.on("init", (user) => {
          if (!user) {
            identity.open();
            openIfNeeded();
          }
        });

        identity.on("login", () => {
          identity.close();
          window.location.reload();
        });

        identity.on("logout", () => {
          identity.open();
        });

        identity.init();
        openIfNeeded();
      });
    </script>
  </body>
</html>
