---
import ConfigCarrier from "@components/ConfigCarrier.astro";
import FontManager from "@components/FontManager.astro";
import MusicPlayer from "@components/widget/MusicPlayer.svelte";

import { profileConfig, siteConfig, sakuraConfig } from "../config";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	DARK_MODE,
	DEFAULT_THEME,
	LIGHT_MODE,
	SYSTEM_MODE,
	PAGE_WIDTH,
} from "../constants/constants";
import { defaultFavicons } from "../constants/icon";
import type { Favicon, SakuraConfig } from "../types/config";
import { pathsEqual, url } from "../utils/url-utils";

import "katex/dist/katex.css";
import "../styles/mobile-navbar.css";
import "../styles/wallpaper-navbar-transparent.css";
import "../styles/fancybox-custom.css";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } =
	Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
	siteConfig.backgroundWallpaper?.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
const shouldShowTopHighlight =
	navbarTransparentMode === "full" || navbarTransparentMode === "semifull";

// 获取默认背景图片的辅助函数
const getDefaultBackground = (): string => {
	const src = siteConfig.backgroundWallpaper.src;
	if (typeof src === "string") {
		return src;
	}
	if (src && typeof src === "object" && !Array.isArray(src)) {
		// 优先使用desktop，如果没有则使用mobile
		const desktopSrc = src.desktop;
		const mobileSrc = src.mobile;
		if (typeof desktopSrc === "string") {
			return desktopSrc;
		}
		if (typeof mobileSrc === "string") {
			return mobileSrc;
		}
	}
	return "";
};

if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = getDefaultBackground();
}

// TODO don't use post cover as banner for now
banner = getDefaultBackground();

const enableBanner = siteConfig.backgroundWallpaper.enable && siteConfig.backgroundWallpaper.mode === "banner";

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
	ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
	top: `${BANNER_HEIGHT_EXTEND}vh`,
	center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
	bottom: "0",
};
const bannerOffset =
	bannerOffsetByPosition[siteConfig.backgroundWallpaper.position || "center"];

---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://identity.netlify.com https://unpkg.com https://www.googletagmanager.com https://www.clarity.ms https://cdn.jsdelivr.net https://www.bilibili.uno; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https: http:; font-src 'self' data: https://cdn.jsdelivr.net; connect-src 'self' https://identity.netlify.com https://*.netlify.app https://unpkg.com https://www.bilibili.uno https://api.injahow.cn https://api.uomg.com; frame-src 'self' https://identity.netlify.com; worker-src 'self' blob:;" />

		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KRX3XGVH');</script>
		<script type="text/javascript">(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "tjr3vkhj8i");</script>

		<title>{pageTitle}</title>
		<meta name="description" content={description || siteConfig.description || pageTitle}>
		{siteConfig.keywords && siteConfig.keywords.length > 0 && (
			<meta name="keywords" content={siteConfig.keywords.join(', ')} />
		)}
		<meta name="author" content={profileConfig.name}>

		<meta property="og:site_name" content={siteConfig.title}>
		<meta property="og:url" content={Astro.url}>
		<meta property="og:title" content={pageTitle}>
		<meta property="og:description" content={description || siteConfig.description || pageTitle}>
		{ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
		{
			setOGTypeArticle ? (
				<meta property="og:type" content="article" />
			) : (
				<meta property="og:type" content="website" />
			)
		}

		<meta name="twitter:card" content="summary_large_image">
		<meta property="twitter:url" content={Astro.url}>
		<meta name="twitter:title" content={pageTitle}>
		<meta name="twitter:description" content={description || siteConfig.description || pageTitle}>

		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		{favicons.map(favicon => (
			<link rel="icon"
				  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
				  sizes={favicon.sizes}
				  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
			/>
		))}

		<!-- Set the theme before the page is rendered to avoid a flash -->
		<script is:inline define:vars={{DEFAULT_THEME, LIGHT_MODE, DARK_MODE, SYSTEM_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue, defaultMode: siteConfig.themeColor.defaultMode || "system"}}>
			// Load the theme from local storage, use defaultMode from config if not set
			const theme = localStorage.getItem('theme') || defaultMode;
			
			// Helper function to get system preference
			function getSystemPreference() {
				return window.matchMedia('(prefers-color-scheme: dark)').matches ? DARK_MODE : LIGHT_MODE;
			}
			
			// Resolve theme (convert system to actual theme)
			function resolveTheme(themeValue) {
				if (themeValue === SYSTEM_MODE) {
					return getSystemPreference();
				}
				return themeValue;
			}
			
			const resolvedTheme = resolveTheme(theme);
			let isDark = false;
			
			switch (resolvedTheme) {
				case LIGHT_MODE:
					document.documentElement.classList.remove('dark');
					isDark = false;
					break
				case DARK_MODE:
					document.documentElement.classList.add('dark');
					isDark = true;
					break
			}
			
			// Setup system theme change listener if using system mode
			if (theme === SYSTEM_MODE) {
				const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
				const handleSystemThemeChange = (e) => {
					const currentStoredTheme = localStorage.getItem('theme');
					if (currentStoredTheme === SYSTEM_MODE) {
						const newTheme = e.matches ? DARK_MODE : LIGHT_MODE;
						const newIsDark = newTheme === DARK_MODE;
						
						if (newIsDark) {
							document.documentElement.classList.add('dark');
						} else {
							document.documentElement.classList.remove('dark');
						}
						
						const expressiveTheme = newIsDark ? "github-dark" : "github-light";
						document.documentElement.setAttribute("data-theme", expressiveTheme);
					}
				};
				
				// Add listener for system theme changes
				mediaQuery.addListener(handleSystemThemeChange);
			}
			
			// Set the theme for Expressive Code based on current mode
			const expressiveTheme = isDark ? "github-dark" : "github-light";
			document.documentElement.setAttribute("data-theme", expressiveTheme);
			
			// 确保主题正确应用 - 解决代码块渲染问题
			// 使用 requestAnimationFrame 确保在下一帧检查主题状态
			requestAnimationFrame(() => {
				const currentTheme = document.documentElement.getAttribute('data-theme');
				if (currentTheme !== expressiveTheme) {
					document.documentElement.setAttribute('data-theme', expressiveTheme);
				}
			});

			// Load the hue from local storage
			const hue = localStorage.getItem('hue') || configHue;
			document.documentElement.style.setProperty('--hue', hue);

			// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
			let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
			offset = offset - offset % 4;
			document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
		</script>
		<style define:vars={{
			configHue,
			'page-width': `${PAGE_WIDTH}rem`,
		}}></style>  <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->



		<slot name="head"></slot>



		<link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

		<!-- Netlify Identity Widget - load synchronously without defer -->
		<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

		<!-- Font Manager -->
		<FontManager />

</head>
	<body class=" min-h-screen " class:list={[
		{"lg:is-home": isHomePage, "enable-banner": enableBanner},
		...(siteConfig.font.enable && siteConfig.font.selected ? 
			(Array.isArray(siteConfig.font.selected) 
				? siteConfig.font.selected 
				: [siteConfig.font.selected]
			).map(fontId => `font-${fontId}-enabled`) : [])
	]}>
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KRX3XGVH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		
		<!-- 页面顶部渐变高光效果 - 只在full和semifull模式下显示 -->
		{shouldShowTopHighlight && <div class="top-gradient-highlight"></div>}
		<ConfigCarrier></ConfigCarrier>
		<slot />
		
		<!-- Music Player -->
		<MusicPlayer client:load />
		
		<!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
		<div id="page-height-extend" class="hidden h-[300vh]"></div>

		<!-- Sakura Effect -->
		{sakuraConfig?.enable && (
			<script define:vars={{ sakuraConfig }}>
				// 樱花对象类
				class Sakura {
					constructor(x, y, s, r, a, fn, idx, img, limitArray, config) {
						this.x = x;
						this.y = y;
						this.s = s;
						this.r = r;
						this.a = a;
						this.fn = fn;
						this.idx = idx;
						this.img = img;
						this.limitArray = limitArray;
						this.config = config;
					}

					draw(cxt) {
						cxt.save();
						cxt.translate(this.x, this.y);
						cxt.rotate(this.r);
						cxt.globalAlpha = this.a;
						cxt.drawImage(this.img, 0, 0, 40 * this.s, 40 * this.s);
						cxt.restore();
					}

					update() {
						this.x = this.fn.x(this.x, this.y);
						this.y = this.fn.y(this.y, this.y);
						this.r = this.fn.r(this.r);
						this.a = this.fn.a(this.a);
						// 如果樱花越界，重新调整位置
						if (
							this.x > window.innerWidth ||
							this.x < 0 ||
							this.y > window.innerHeight ||
							this.y < 0 ||
							this.a <= 0
						) {
							// 如果樱花不做限制
							if (this.limitArray[this.idx] === -1) {
								this.resetPosition();
							}
							// 否则樱花有限制
							else {
								if (this.limitArray[this.idx] > 0) {
									this.resetPosition();
									this.limitArray[this.idx]--;
								}
							}
						}
					}

					resetPosition() {
						this.r = getRandom('fnr', this.config);
						if (Math.random() > 0.4) {
							this.x = getRandom('x', this.config);
							this.y = 0;
							this.s = getRandom('s', this.config);
							this.r = getRandom('r', this.config);
							this.a = getRandom('a', this.config);
						} else {
							this.x = window.innerWidth;
							this.y = getRandom('y', this.config);
							this.s = getRandom('s', this.config);
							this.r = getRandom('r', this.config);
							this.a = getRandom('a', this.config);
						}
					}
				}

				// 樱花列表类
				class SakuraList {
					constructor() {
						this.list = [];
					}

					push(sakura) {
						this.list.push(sakura);
					}

					update() {
						for (let i = 0, len = this.list.length; i < len; i++) {
							this.list[i].update();
						}
					}

					draw(cxt) {
						for (let i = 0, len = this.list.length; i < len; i++) {
							this.list[i].draw(cxt);
						}
					}

					get(i) {
						return this.list[i];
					}

					size() {
						return this.list.length;
					}
				}

				// 获取随机值的函数
				function getRandom(option, config) {
					let ret;
					let random;

					switch (option) {
						case 'x':
							ret = Math.random() * window.innerWidth;
							break;
						case 'y':
							ret = Math.random() * window.innerHeight;
							break;
						case 's':
							ret = config.size.min + Math.random() * (config.size.max - config.size.min);
							break;
						case 'r':
							ret = Math.random() * 6;
							break;
						case 'a':
							ret = config.opacity.min + Math.random() * (config.opacity.max - config.opacity.min);
							break;
						case 'fnx':
							random = config.speed.horizontal.min + Math.random() * (config.speed.horizontal.max - config.speed.horizontal.min);
							ret = function (x, y) {
								return x + random;
							};
							break;
						case 'fny':
							random = config.speed.vertical.min + Math.random() * (config.speed.vertical.max - config.speed.vertical.min);
							ret = function (x, y) {
								return y + random;
							};
							break;
						case 'fnr':
							ret = function (r) {
								return r + config.speed.rotation;
							};
							break;
						case 'fna':
							ret = function (alpha) {
								return alpha - config.speed.fadeSpeed * 0.01;
							};
							break;
					}
					return ret;
				}

				// 樱花管理器类
				class SakuraManager {
					constructor(config) {
						this.config = config;
						this.canvas = null;
						this.ctx = null;
						this.sakuraList = null;
						this.animationId = null;
						this.img = null;
						this.isRunning = false;
					}

					// 初始化樱花特效
					async init() {
						if (!this.config.enable || this.isRunning) {
							return;
						}

						// 创建图片对象
						this.img = new Image();
						this.img.src = '/assets/images/sakura.png'; // 使用樱花图片

						// 等待图片加载完成
						await new Promise((resolve, reject) => {
							if (this.img) {
								this.img.onload = () => resolve();
								this.img.onerror = () => reject(new Error('Failed to load sakura image'));
							}
						});

						this.createCanvas();
						this.createSakuraList();
						this.startAnimation();
						this.isRunning = true;
					}

					// 创建画布
					createCanvas() {
						this.canvas = document.createElement('canvas');
						this.canvas.height = window.innerHeight;
						this.canvas.width = window.innerWidth;
						this.canvas.setAttribute('style', `position: fixed; left: 0; top: 0; pointer-events: none; z-index: ${this.config.zIndex};`);
						this.canvas.setAttribute('id', 'canvas_sakura');
						document.body.appendChild(this.canvas);
						this.ctx = this.canvas.getContext('2d');

						// 监听窗口大小变化
						window.addEventListener('resize', this.handleResize.bind(this));
					}

					// 创建樱花列表
					createSakuraList() {
						if (!this.img || !this.ctx) return;

						this.sakuraList = new SakuraList();
						const limitArray = new Array(this.config.sakuraNum).fill(this.config.limitTimes);

						for (let i = 0; i < this.config.sakuraNum; i++) {
							const randomX = getRandom('x', this.config);
							const randomY = getRandom('y', this.config);
							const randomS = getRandom('s', this.config);
							const randomR = getRandom('r', this.config);
							const randomA = getRandom('a', this.config);
							const randomFnx = getRandom('fnx', this.config);
							const randomFny = getRandom('fny', this.config);
							const randomFnR = getRandom('fnr', this.config);
							const randomFnA = getRandom('fna', this.config);

							const sakura = new Sakura(
								randomX,
								randomY,
								randomS,
								randomR,
								randomA,
								{
									x: randomFnx,
									y: randomFny,
									r: randomFnR,
									a: randomFnA,
								},
								i,
								this.img,
								limitArray,
								this.config
							);

							sakura.draw(this.ctx);
							this.sakuraList.push(sakura);
						}
					}

					// 开始动画
					startAnimation() {
						if (!this.ctx || !this.canvas || !this.sakuraList) return;

						const animate = () => {
							if (!this.ctx || !this.canvas || !this.sakuraList) return;

							this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
							this.sakuraList.update();
							this.sakuraList.draw(this.ctx);
							this.animationId = requestAnimationFrame(animate);
						};

						this.animationId = requestAnimationFrame(animate);
					}

					// 处理窗口大小变化
					handleResize() {
						if (this.canvas) {
							this.canvas.width = window.innerWidth;
							this.canvas.height = window.innerHeight;
						}
					}

					// 停止樱花特效
					stop() {
						if (this.animationId) {
							cancelAnimationFrame(this.animationId);
							this.animationId = null;
						}

						if (this.canvas) {
							document.body.removeChild(this.canvas);
							this.canvas = null;
						}

						window.removeEventListener('resize', this.handleResize.bind(this));
						this.isRunning = false;
					}

					// 切换樱花特效
					toggle() {
						if (this.isRunning) {
							this.stop();
						} else {
							this.init();
						}
					}

					// 更新配置
					updateConfig(newConfig) {
						const wasRunning = this.isRunning;
						if (wasRunning) {
							this.stop();
						}
						this.config = newConfig;
						if (wasRunning && newConfig.enable) {
							this.init();
						}
					}

					// 获取运行状态
					getIsRunning() {
						return this.isRunning;
					}
				}

				// 创建全局樱花管理器实例
				let globalSakuraManager = null;

				// 初始化樱花特效
				function initSakura(config) {
					if (globalSakuraManager) {
						globalSakuraManager.updateConfig(config);
					} else {
						globalSakuraManager = new SakuraManager(config);
						if (config.enable) {
							globalSakuraManager.init();
						}
					}
				}

				// 樱花特效初始化
				(function() {
					// 全局标记，确保樱花特效只初始化一次
					if (window.sakuraInitialized) {
						return;
					}
					
					// 初始化樱花特效的函数
					const setupSakura = () => {
						if (sakuraConfig.enable && !window.sakuraInitialized) {
							initSakura(sakuraConfig);
							window.sakuraInitialized = true;
						}
					};
					
					// 页面加载完成后初始化樱花特效
					if (document.readyState === 'loading') {
						document.addEventListener('DOMContentLoaded', setupSakura);
					} else {
						setupSakura();
					}
				})();
			</script>
		)}
		
		
	</body>
</html>

<style is:global define:vars={{
	bannerOffset,
	'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
	'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
	.enable-banner.is-home #banner-wrapper {
		@apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
	}
	.enable-banner #banner-wrapper {
		@apply h-[var(--banner-height-home)]
	}

	.enable-banner.is-home #banner {
		@apply h-[var(--banner-height-home)] translate-y-0
	}
	.enable-banner #banner {
		@apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
	}
	.enable-banner.is-home #main-grid {
		@apply translate-y-[var(--banner-height-extend)];
	}
	.enable-banner #top-row {
		@apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
	}
	.enable-banner.is-home #sidebar-sticky {
		@apply top-[calc(1rem_-_var(--banner-height-extend))]
	}
	.navbar-hidden {
		@apply opacity-0 -translate-y-16
	}
	
	/* Water waves animation */
	.waves > .parallax use {
		animation: wave 25s cubic-bezier(0.5, 0.5, 0.45, 0.5) infinite;
	}

	@keyframes wave {
		0% {
			transform: translate3d(-90px, 0, 0);
		}
		100% {
			transform: translate3d(85px, 0, 0);
		}
	}

	/* 使用浏览器原生滚动条，无自定义样式 */
}
</style>

<script>
import {getHue, getStoredTheme, setHue, setTheme} from "../utils/setting-utils";
import {pathsEqual, url} from "../utils/url-utils";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_HOME,
	BANNER_HEIGHT_EXTEND,
	MAIN_PANEL_OVERLAPS_BANNER_HEIGHT
} from "../constants/constants";
import { siteConfig } from '../config';

/* Preload fonts */
// (async function() {
// 	try {
// 		await Promise.all([
// 			document.fonts.load("400 1em Roboto"),
// 			document.fonts.load("700 1em Roboto"),
// 		]);
// 		document.body.classList.remove("hidden");
// 	} catch (error) {
// 		console.log("Failed to load fonts:", error);
// 	}
// })();

/* TODO This is a temporary solution for style flicker issue when the transition is activated */
/* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
/* update: fixed in Astro 3.2.4 */
/*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

const bannerEnabled = !!document.getElementById('banner-wrapper')

function setClickOutsideToClose(panel: string, ignores: string[]) {
	document.addEventListener("click", event => {
		let panelDom = document.getElementById(panel);
		let tDom = event.target;
		if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
		for (let ig of ignores) {
			let ie = document.getElementById(ig)
			if (ie == tDom || (ie?.contains(tDom))) {
				return;
			}
		}
		panelDom!.classList.add("float-panel-closed");
	});
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])


function loadTheme() {
	const theme = getStoredTheme()
	setTheme(theme)
}

function loadHue() {
	setHue(getHue())
}

function initCustomScrollbar() {
	// 只处理katex元素的滚动条，使用浏览器原生滚动条
	const katexElements = document.querySelectorAll('.katex-display:not([data-scrollbar-initialized])') as NodeListOf<HTMLElement>;
	katexElements.forEach(element => {
		if (!element.parentNode) return;

		const container = document.createElement('div');
		container.className = 'katex-display-container';
		element.parentNode.insertBefore(container, element);
		container.appendChild(element);

		// 使用浏览器原生滚动条，无自定义样式
		container.style.cssText = `
			overflow-x: auto;
		`;

		element.setAttribute('data-scrollbar-initialized', 'true');
	});
}

function showBanner() {
	const isBannerMode = siteConfig.backgroundWallpaper.mode === "banner";
	if (!siteConfig.backgroundWallpaper.enable || !isBannerMode) return;

	// 使用requestAnimationFrame优化DOM操作
	requestAnimationFrame(() => {
		// Handle single image banner (desktop)
		const banner = document.getElementById('banner');
		if (banner) {
			banner.classList.remove('opacity-0', 'scale-105');
		}

		// Handle mobile single image banner - 使用与电脑端相同的逻辑
		const mobileBanner = document.querySelector('.block.lg\\:hidden[alt="Mobile banner image of the blog"]');
		if (mobileBanner) {
			// 移动端使用与电脑端相同的初始化逻辑
			mobileBanner.classList.remove('opacity-0', 'scale-105');
			mobileBanner.classList.add('opacity-100');
		}

		// 轮播功能已移除
	});
}

// 轮播功能已移除





const setup = () => {
	// TODO: temp solution to change the height of the banner
/*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
	window.swup.hooks.on('link:click', () => {
		// Remove the delay for the first time page load
		document.documentElement.style.setProperty('--content-delay', '0ms')

		// 简化navbar处理逻辑
		if (bannerEnabled) {
			const navbar = document.getElementById('navbar-wrapper')
			if (navbar && document.body.classList.contains('lg:is-home')) {
				const threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 88
				if (document.documentElement.scrollTop >= threshold) {
					navbar.classList.add('navbar-hidden')
				}
			}
		}
	})
	window.swup.hooks.on('content:replace', () => {
		// 只处理katex元素的容器，使用浏览器原生滚动条
		initCustomScrollbar();
		
		// 检查当前页面是否为文章页面（有TOC元素）
		const tocWrapper = document.getElementById('toc-wrapper');
		const isArticlePage = tocWrapper !== null;
		
		// 只在文章页面重新初始化桌面端 TOC 组件
		if (isArticlePage) {
			const tocElement = document.querySelector('table-of-contents');
			if (tocElement && typeof (tocElement as any).init === 'function') {
				setTimeout(() => {
					(tocElement as any).init();
				}, 100);
			}
		}
		
		// 移动端 TOC 组件需要在所有页面都重新初始化
		// 因为它在首页显示文章列表，在其他页面显示目录
		if (typeof (window as any).mobileTOCInit === 'function') {
			setTimeout(() => {
				(window as any).mobileTOCInit();
			}, 100);
		}
		
		
		
		// 重新初始化semifull模式的滚动检测
		const navbar = document.getElementById('navbar')
		if (navbar) {
			const transparentMode = navbar.getAttribute('data-transparent-mode')
			
			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof (window as any).initSemifullScrollDetection === 'function') {
					(window as any).initSemifullScrollDetection()
				}
			}
		}
	})
	window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
		// change banner height immediately when a link is clicked
		const bodyElement = document.querySelector('body')
		const isHomePage = pathsEqual(visit.to.url, url('/'))
		
		if (isHomePage) {
			bodyElement!.classList.add('lg:is-home');
		} else {
			bodyElement!.classList.remove('lg:is-home');
		}

		// Control banner text visibility based on page
		const bannerTextOverlay = document.querySelector('.banner-text-overlay')
		if (bannerTextOverlay) {
			if (isHomePage) {
				bannerTextOverlay.classList.remove('hidden')
			} else {
				bannerTextOverlay.classList.add('hidden')
			}
		}

		// Control navbar transparency based on page
		const navbar = document.getElementById('navbar')
		if (navbar) {
			navbar.setAttribute('data-is-home', isHomePage.toString())
			
			// 重新初始化semifull模式的滚动检测
			const transparentMode = navbar.getAttribute('data-transparent-mode')
			if (transparentMode === 'semifull') {
				// 重新调用初始化函数来重新绑定滚动事件
				if (typeof window.initSemifullScrollDetection === 'function') {
					window.initSemifullScrollDetection()
				}
			}
		}

		// Control mobile banner visibility based on page with improved staging animation
		const bannerWrapper = document.getElementById('banner-wrapper')
		const mainContentWrapper = document.querySelector('.absolute.w-full.z-30')
		
		if (bannerWrapper && mainContentWrapper) {
			if (isHomePage) {
				// 首页：延迟移除隐藏类，让banner和内容优雅地出现
				setTimeout(() => {
					bannerWrapper.classList.remove('mobile-hide-banner')
				}, 100)
				setTimeout(() => {
					mainContentWrapper.classList.remove('mobile-main-no-banner')
				}, 150)
			} else {
				// 非首页：分阶段隐藏，先隐藏banner，再移动内容
				bannerWrapper.classList.add('mobile-hide-banner')
				// 延迟移动内容，让banner先完全消失
				setTimeout(() => {
					mainContentWrapper.classList.add('mobile-main-no-banner')
				}, 100)
			}
		}

		// increase the page height during page transition to prevent the scrolling animation from jumping
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}

		// Hide the TOC while scrolling back to top
		let toc = document.getElementById('toc-wrapper');
		if (toc) {
			toc.classList.add('toc-not-ready')
		}
	});
	window.swup.hooks.on('page:view', () => {
		// hide the temp high element when the transition is done
		const heightExtend = document.getElementById('page-height-extend')
		if (heightExtend) {
			heightExtend.classList.remove('hidden')
		}
		
		// 确保页面滚动到顶部，特别是移动端banner关闭时
		window.scrollTo({
			top: 0,
			behavior: 'instant'
		});
		
		// 同步主题状态 - 解决从首页进入文章页面时代码块渲染问题
		const storedTheme = localStorage.getItem('theme') || 'LIGHT_MODE';
		const isDark = storedTheme === 'DARK_MODE';
		const expectedTheme = isDark ? 'github-dark' : 'github-light';
		const currentTheme = document.documentElement.getAttribute('data-theme');
		
		// 如果主题不匹配，强制重新应用
		if (currentTheme !== expectedTheme) {
			document.documentElement.setAttribute('data-theme', expectedTheme);
			// 触发代码块重新渲染
			setTimeout(() => {
				window.dispatchEvent(new CustomEvent('theme-change'));
			}, 50);
		}
		
		// 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
		setTimeout(() => {
			if (document.getElementById('tcomment')) {
				// 触发自定义事件，通知评论系统页面已完全加载
				const pageLoadedEvent = new CustomEvent('firefly:page:loaded', {
					detail: {
						path: window.location.pathname,
						timestamp: Date.now()
					}
				});
				document.dispatchEvent(pageLoadedEvent);
				console.log('Layout: 触发 firefly:page:loaded 事件，路径:', window.location.pathname);
			}
		}, 300);
	});
	window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
		setTimeout(() => {
			const heightExtend = document.getElementById('page-height-extend')
			if (heightExtend) {
				heightExtend.classList.add('hidden')
			}

            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
	});
}
if (window?.swup?.hooks) {
	setup()
} else {
	document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')

// 节流函数
function throttle(func: Function, limit: number) {
	let inThrottle: boolean;
	return function(this: any) {
		const args = arguments;
		const context = this;
		if (!inThrottle) {
			func.apply(context, args);
			inThrottle = true;
			setTimeout(() => inThrottle = false, limit);
		}
	}
}

function scrollFunction() {
	const scrollTop = document.documentElement.scrollTop;
	const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

	// 批量处理DOM操作
	requestAnimationFrame(() => {
		if (backToTopBtn) {
			if (scrollTop > bannerHeight) {
				backToTopBtn.classList.remove('hide')
			} else {
				backToTopBtn.classList.add('hide')
			}
		}

		if (bannerEnabled && toc) {
			if (scrollTop > bannerHeight) {
				toc.classList.remove('toc-hide')
			} else {
				toc.classList.add('toc-hide')
			}
		}

		if (bannerEnabled && navbar) {
			const isHome = document.body.classList.contains('lg:is-home') && window.innerWidth >= 1024;
			const currentBannerHeight = isHome ? BANNER_HEIGHT_HOME : BANNER_HEIGHT;
			const threshold = window.innerHeight * (currentBannerHeight / 100) - 88;
			
			if (scrollTop >= threshold) {
				navbar.classList.add('navbar-hidden')
			} else {
				navbar.classList.remove('navbar-hidden')
			}
		}
	});
}

// 使用节流优化滚动性能
window.onscroll = throttle(scrollFunction, 16); // 约60fps

window.onresize = () => {
	// calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
	let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
	offset = offset - offset % 4;
	document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

// 页面加载完成后初始化banner和katex容器
if (document.readyState === 'loading') {
	document.addEventListener('DOMContentLoaded', () => {
		showBanner();
		initCustomScrollbar();
	});
} else {
	showBanner();
	initCustomScrollbar();
}

</script>

<script>
import { Fancybox } from "@fancyapps/ui";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

function initFancybox() {
  // 销毁现有的 Fancybox 实例（如果存在）
  Fancybox.close();
  
  // 为相册图片添加 Fancybox 支持
  Fancybox.bind(".custom-md img, #post-cover img, .moment-images img", {
    groupAll: true,
    Thumbs: {
      autoStart: true,
      showOnStart: "yes",
    },
    // 添加自定义按钮
    Toolbar: {
      display: {
        left: ["infobar"],
        middle: [
          "zoomIn",
          "zoomOut",
          "toggle1to1",
          "rotateCCW",
          "rotateCW",
          "flipX",
          "flipY",
        ],
        right: ["slideshow", "thumbs", "close"],
      },
    },
    // 动画效果
    animated: true,
    // 是否支持拖拽
    dragToClose: true,
    // 是否支持键盘导航
    keyboard: {
      Escape: "close",
      Delete: "close",
      Backspace: "close",
      PageUp: "next",
      PageDown: "prev",
      ArrowUp: "next",
      ArrowDown: "prev",
      ArrowRight: "next",
      ArrowLeft: "prev",
    },
    // 自适应图片大小
    fitToView: true,
    // 图片预加载
    preload: 3,
    // 循环浏览
    infinite: true,
    // 智能图片适配
    Panzoom: {
      maxScale: 3,
      minScale: 1,
    },
    // 幻灯片设置
    Carousel: {
      transition: "slide",
      preload: 2,
    },
    // 禁用标题显示
    caption: false
  });
  
  // 为相册中的链接添加 Fancybox 支持
  Fancybox.bind(".moment-images a[data-fancybox]", {
    Thumbs: {
      autoStart: true,
      showOnStart: "yes",
    },
    // 工具栏配置
    Toolbar: {
      display: {
        left: ["infobar"],
        middle: [
          "zoomIn",
          "zoomOut",
          "toggle1to1",
          "rotateCCW",
          "rotateCW",
          "flipX",
          "flipY",
        ],
        right: ["slideshow", "thumbs", "close"],
      },
    },
    // 动画效果
    animated: true,
    // 是否支持拖拽
    dragToClose: true,
    // 是否支持键盘导航
    keyboard: {
      Escape: "close",
      Delete: "close",
      Backspace: "close",
      PageUp: "next",
      PageDown: "prev",
      ArrowUp: "next",
      ArrowDown: "prev",
      ArrowRight: "next",
      ArrowLeft: "prev",
    },
    // 自适应图片大小
    fitToView: true,
    // 图片预加载
    preload: 3,
    // 循环浏览
    infinite: true,
    // 智能图片适配
    Panzoom: {
      maxScale: 3,
      minScale: 1,
    },
    // 自定义源获取
    source: (el) => {
      return el.getAttribute("data-src") || el.getAttribute("href");
    },
    // 禁用标题显示
    caption: false
  });
  
  // 为单独的 fancybox 图片添加支持
  Fancybox.bind("[data-fancybox]:not(.moment-images a)", {
    // 自定义选项
    Thumbs: {
      autoStart: true,
      showOnStart: "yes",
    },
    // 工具栏配置
    Toolbar: {
      display: {
        left: ["infobar"],
        middle: [
          "zoomIn",
          "zoomOut",
          "toggle1to1",
          "rotateCCW",
          "rotateCW",
          "flipX",
          "flipY",
        ],
        right: ["slideshow", "thumbs", "close"],
      },
    },
    // 动画效果
    animated: true,
    // 是否支持拖拽
    dragToClose: true,
    // 是否支持键盘导航
    keyboard: {
      Escape: "close",
      Delete: "close",
      Backspace: "close",
      PageUp: "next",
      PageDown: "prev",
      ArrowUp: "next",
      ArrowDown: "prev",
      ArrowRight: "next",
      ArrowLeft: "prev",
    },
    // 自适应图片大小
    fitToView: true,
    // 图片预加载
    preload: 3,
    // 循环浏览
    infinite: true,
    // 智能图片适配
    Panzoom: {
      maxScale: 3,
      minScale: 1,
    },
    // 禁用标题显示
    caption: false
  });
}

const setup = () => {
  // 初始化 Fancybox
  initFancybox();
  
  // 在页面视图更改时重新初始化
  window.swup.hooks.on("page:view", () => {
    // 等待 DOM 更新后初始化
    setTimeout(() => {
      initFancybox();
    }, 100);
  });
}

if (window.swup) {
  setup()
} else {
  document.addEventListener("swup:enable", setup)
  
  // 如果 swup 尚未初始化，则直接初始化
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initFancybox);
  } else {
    initFancybox();
  }
}
</script>

<script is:inline>
	if (typeof window !== "undefined") {
		const setupIdentity = () => {
			const identity = window.netlifyIdentity;
			if (!identity || identity.__astroSetup) return;
			identity.__astroSetup = true;

			console.log('[Netlify Identity] Setting up identity widget');

			const openIfToken = () => {
				const hash = window.location.hash || "";
				console.log('[Netlify Identity] Checking hash:', hash);

				if (hash.startsWith("#recovery_token")) {
					console.log('[Netlify Identity] Opening login modal for password recovery');
					identity.open(); // Open without parameter, let widget auto-detect recovery token
					return true;
				}
				if (hash.startsWith("#invite_token") || hash.startsWith("#confirmation_token")) {
					console.log('[Netlify Identity] Opening signup modal');
					identity.open("signup");
					return true;
				}
				return false;
			};

			identity.on("init", (user) => {
				console.log('[Netlify Identity] Initialized, user:', user ? 'logged in' : 'not logged in');
				if (!user) {
					openIfToken();
				}
			});

			identity.on("login", () => {
				console.log('[Netlify Identity] User logged in, redirecting to /admin/');
				identity.close();
				window.location.hash = "";
				window.location.href = "/admin/";
			});

			identity.on("error", (err) => {
				console.error('[Netlify Identity] Error:', err);
			});

			window.addEventListener("hashchange", openIfToken);

			try {
				identity.init();
				// Give init a moment to complete before checking for token
				setTimeout(() => {
					openIfToken();
				}, 100);
			} catch (err) {
				console.error('[Netlify Identity] Failed to initialize:', err);
			}
		};

		let attempts = 0;
		const maxAttempts = 100; // 5 seconds total

		const waitForIdentity = () => {
			attempts++;
			if (window.netlifyIdentity) {
				console.log('[Netlify Identity] Widget loaded after', attempts, 'attempts');
				setupIdentity();
			} else if (attempts < maxAttempts) {
				window.setTimeout(waitForIdentity, 50);
			} else {
				console.error('[Netlify Identity] Widget failed to load after 5 seconds');
			}
		};

		// Try both DOMContentLoaded and window.load
		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", waitForIdentity);
		} else if (document.readyState === "interactive") {
			// DOM ready but resources may still be loading
			window.addEventListener("load", waitForIdentity);
			waitForIdentity(); // Also try immediately
		} else {
			// Document fully loaded
			waitForIdentity();
		}
	}
</script>
